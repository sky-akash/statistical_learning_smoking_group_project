#Load Dataset
attach(Smoking_Training_Data)

#Create Dataframe
df = Smoking_Training_Data

head(df)

str(df)

colnames(df)

df <- na.omit(df)
str(df)

summary(df)

#Renaming Colnames for simplicity
colnames(df)[colnames(df) == "height(cm)"] <- "height_cm"
colnames(df)[colnames(df) == "weight(kg)"] <- "weight_kg"
colnames(df)[colnames(df) == "waist(cm)"] <- "waist_cm"
colnames(df)[colnames(df) == "eyesight(left)"] <- "eyesight_left"
colnames(df)[colnames(df) == "eyesight(right)"] <- "eyesight_right"
colnames(df)[colnames(df) == "hearing(left)"] <- "hearing_left"
colnames(df)[colnames(df) == "hearing(right)"] <- "hearing_right"
colnames(df)[colnames(df) == "fasting blood sugar"] <- "fasting_blood_sugar"
colnames(df)[colnames(df) == "Urine protein"] <- "urine_protein"
colnames(df)[colnames(df) == "serum creatinine"] <- "serum_creatinine"
colnames(df)[colnames(df) == "dental caries"] <- "dental_caries"

str(df)

#Adding Extra Columns to dataset for Derived Variables 
# Var1 is WHtR (Waist to Height Ratio) = waist (cm)/ height (cm)
# Var2 is as_lt i.e. AST / ALT ratio
# Var3 is BMI, Body Mass Index = Weight (kg)/ height^2 (m)


df$WHtR <- df$waist_cm/df$height_cm
df$as_lt <- df$AST/df$ALT
df$BMI <- df$weight_kg / (df$height_cm/100)

str(df)

# Splitting Dataset for Training, Validation and Test
set.seed(1)
#To split the dataset randomly into the three categories, let's generate random indices to split the dataset

indices <- sample(1:nrow(df), size=nrow(df), replace=FALSE) #Random Sampling the whole dataset without repetition

# Define proportions for splitting
train_prop <- 0.7  # 70% for training
val_prop <- 0.15   # 15% for validation
test_prop <- 0.15  # 15% for testing

# Calculate the number of samples for each set
train_size <- round(train_prop * nrow(df))
val_size <- round(val_prop * nrow(df))
test_size <- nrow(df) - train_size - val_size


# Split the data
train_data <- df[indices[1:train_size], ]
val_data <- df[indices[(train_size + 1):(train_size + val_size)], ]
test_data <- df[indices[(train_size + val_size + 1):nrow(df)], ]

# Let's print the dimensions of the split datasets
dim(train_data)
dim(val_data)
dim(test_data)

# Training Dataset
library(ggplot2)

# Generate box plots for each variable
par(mfrow = c(5, 5))  # Set up a multi-panel plot
for (i in 1:26) {
  boxplot(train_data[, i], main = colnames(df)[i], col = "skyblue", border = "black", horizontal = TRUE)
}


df$dental_caries <- factor(df$dental_caries)

# Logistic Regression

install.packages("glmnet")

library(glmnet)

#Pair Plots of Training Data

pairs(train_data)
# Fit logistic regression model
model <- glm(smoking ~ ., data = train_data, family = binomial)

# Summary of the model
summary(model)


# Residuals
residuals <- residuals(model)
#residuals

# Deviance
deviance <- deviance(model)
#deviance

# Confusion Matrix
predicted <- ifelse(predict(model, newdata = train_data, type = "response") > 0.5, 1, 0)
confusion_matrix <- table(predicted, train_data$smoking)
print(confusion_matrix)


# ROC Curve and AUC
library(pROC)
roc_curve <- roc(train_data$smoking, predict(model, newdata = train_data, type = "response"))
plot(roc_curve, main = "ROC Curve")
auc(roc_curve)

#Install Resource-Selection Package
install.packages("ResourceSelection")
library(ResourceSelection)

# Hosmer-Lemeshow Test
hoslem.test(train_data$smoking, fitted(model))



#################################

# Let's Run PCA for dimensionality reduction, as the results from logistic doesn't seem to be clustering the data properly.

# Load required library
library(stats)

# Perform PCA
pca_result <- prcomp(train_data[, -which(names(train_data) == "smoking")], scale. = TRUE)

# Summary of PCA
summary(pca_result)

# Proportion of variance explained by each principal component
prop_var <- pca_result$sdev^2 / sum(pca_result$sdev^2)
prop_var


#Let's Build model using selected Principal Components 

# Choose principal components explaining at least 4% variation
selected_pcs <- which(prop_var >= 0.07)
selected_pcs

# Modeling 

# Extract the selected principal components from the PCA result
selected_pc_data <- pca_result$x[, selected_pcs]

# Combine the selected principal components with the response variable
pc_with_response <- cbind(selected_pc_data, smoking = train_data$smoking)
pc_with_response_df <- as.data.frame(pc_with_response)


# Fit logistic regression model with selected principal components
logit_model <- glm(smoking ~ ., data = pc_with_response_df, family = binomial)

# Summary of the logistic regression model
summary(logit_model)

# Confusion Matrix
predicted <- ifelse(predict(logit_model, newdata = pc_with_response_df, type = "response") > 0.5, 1, 0)
confusion_matrix <- table(predicted, pc_with_response_df$smoking)
print(confusion_matrix)

# ROC Curve and AUC
library(pROC)
roc_curve <- roc(pc_with_response_df$smoking, predict(logit_model, newdata = pc_with_response_df, type = "response"))
plot(roc_curve, main = "ROC Curve")
auc(roc_curve)

# Hosmer-Lemeshow Test
hoslem.test(pc_with_response_df$smoking, fitted(logit_model))


# Let's check non-linearity in data - 

# Residual Analysis
residuals <- residuals(logit_model)
plot(residuals ~ predicted, main = "Residuals vs Fitted", xlab = "Fitted Values", ylab = "Residuals")

# Fit logistic regression model with interaction terms
logit_model_interaction <- glm(smoking ~ selected_pc_data[,1] * selected_pc_data[,2], 
                                data = pc_with_response_df, family = binomial)
summary(logit_model_interaction)


# Partial Dependence Plots (Example for one predictor)
library(pdp)
for i in range[1:]
partial_plot <- partial(logit_model, pred.var = "selected_pc_data[,1]", plot = TRUE)


<!-- # Residuals -->
<!-- residuals <- residuals(logit_model) -->
<!-- #residuals -->

<!-- # Deviance -->
<!-- deviance <- deviance(logit_model) -->
<!-- #deviance -->

<!-- # Confusion Matrix -->
<!-- predicted <- ifelse(predict(logit_model, newdata = pc_with_response_df, type = "response") > 0.5, 1, 0) -->
<!-- confusion_matrix <- table(predicted, pc_with_response_df$smoking) -->
<!-- print(confusion_matrix) -->


<!-- # ROC Curve and AUC -->
<!-- library(pROC) -->
<!-- roc_curve <- roc(pc_with_response_df$smoking, predict(model, newdata = pc_with_response_df, type = "response")) -->
<!-- plot(roc_curve, main = "ROC Curve") -->
<!-- auc(roc_curve) -->

<!-- # Hosmer-Lemeshow Test -->
<!-- hoslem.test(train_data$smoking, fitted(model)) -->







